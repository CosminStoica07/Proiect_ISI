<html>
<head>
    <meta charSet="utf-8">
    <meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>Proiect ISI</title>

    <style>
        html, body, #viewDiv {
            padding: 0;
            margin: 0;
            height: 100%;
            width: 100%;
        }
        .action {
            color: blue;
            cursor: pointer;
            text-decoration: underline;
        }
    </style>
    <link rel="stylesheet" href="https://js.arcgis.com/4.17/esri/themes/light/main.css">

    <script>
        var dojoConfig = {
            packages: [
                {
                    name: "geolocate",
                    location: "//2gis.github.io/mock-geolocation/dist",
                    main: "geolocate"
                }
            ]
        };
    </script>

    <script src="https://js.arcgis.com/4.17/"></script>

    <script>
        require([/*
            "esri/intl",*/
            "esri/portal/Portal",
            "esri/identity/OAuthInfo",
            "esri/identity/IdentityManager",
            "dojo/dom-style",
            "dojo/dom-attr",
            "dojo/on",
            "dojo/dom",
            "geolocate",
            "esri/Map",
            "esri/views/MapView",
            "esri/widgets/Locate",
            "esri/widgets/Track",
            "esri/Graphic",
            "esri/layers/MapImageLayer",
            "esri/geometry/Circle",
            "esri/views/SceneView",
            "esri/geometry/Point",
            "esri/geometry/Polygon"
        ], function (/*intl, */Portal, OAuthInfo, identityManager, domStyle, domAttr, on, dom,
                     geolocate, Map, MapView, Locate, Track, Graphic, MapImageLayer, Circle, SceneView, Point, Polygon) {

            var portalUrl = "https://www.arcgis.com/sharing";

            var info = new OAuthInfo({
                appId: "koRRijqbOKPqMsaP", //*** TODO: Your Client ID value goes here ***//
                popup: false // inline redirects don't require any additional app configuration
            });

            identityManager.registerOAuthInfos([info]);

            // send users to arcgis.com to login
            on(dom.byId("sign-in"), "click", function() {
                identityManager.getCredential(portalUrl);
            });

            // log out and reload
            on(dom.byId("sign-out"), "click", function() {
                identityManager.destroyCredentials();
                window.location.reload();
            });

            identityManager.checkSignInStatus(portalUrl).then(function() {
                dom.byId('anonymousPanel').style.display = 'none';
                dom.byId('personalizedPanel').style.display = 'block';
                displayMap();
            });

            /**
             *
             * Function used to disable users controls
             * Don't allow the user to zoom/move etc.
             *
             **/
            function disableZooming(view) {
                view.popup.dockEnabled = true;

                // Removes the zoom action on the popup
                view.popup.actions = [];

                // stops propagation of default behavior when an event fires
                function stopEvtPropagation(event) {
                    event.stopPropagation();
                }

                // exlude the zoom widget from the default UI
                view.ui.components = ["attribution"];

                // disable mouse wheel scroll zooming on the view
                view.on("mouse-wheel", stopEvtPropagation);

                // disable zooming via double-click on the view
                view.on("double-click", stopEvtPropagation);

                // disable zooming out via double-click + Control on the view
                view.on("double-click", ["Control"], stopEvtPropagation);

                // disables pinch-zoom and panning on the view
                view.on("drag", stopEvtPropagation);

                // disable the view's zoom box to prevent the Shift + drag
                // and Shift + Control + drag zoom gestures.
                view.on("drag", ["Shift"], stopEvtPropagation);
                view.on("drag", ["Shift", "Control"], stopEvtPropagation);

                // prevents zooming with the + and - keys
                view.on("key-down", function (event) {
                    var prohibitedKeys = ["+", "-", "Shift", "_", "="];
                    var keyPressed = event.key;
                    if (prohibitedKeys.indexOf(keyPressed) !== -1) {
                        event.stopPropagation();
                    }
                });

                return view;
            }

            /**
             *
             * Function used to SceneView
             *
             **/
            function getHeading(point, oldPoint) {
                // get angle between two points
                var angleInDegrees =
                    (Math.atan2(point.y - oldPoint.y, point.x - oldPoint.x) * 180) /
                    Math.PI;

                // move heading north
                return -90 + angleInDegrees;
            }

            /**
             *
             * Function used to simulate the user movement for demo
             *
             **/
            function stubGeolocation() {
                var coords = [
                        {
                            lat: 34.05648363780692,
                            lng: -117.19565501782613
                        },
                        {
                            lng: -117.19565880345007,
                            lat: 34.05682230352545
                        },
                        {
                            lng: -117.19566258907402,
                            lat: 34.05716096924398
                        },
                        {
                            lng: -117.19566637469796,
                            lat: 34.05749963496251
                        },
                        {
                            lng: -117.19567016032191,
                            lat: 34.05783830068104
                        },
                        {
                            lng: -117.19567394594586,
                            lat: 34.05817696639957
                        },
                        {
                            lng: -117.1956777315698,
                            lat: 34.0585156321181
                        },
                        {
                            lng: -117.19568151719375,
                            lat: 34.05885429783663
                        },
                        {
                            lng: -117.1956853028177,
                            lat: 34.05919296355516
                        },
                        {
                            lat: 34.059192963555134,
                            lng: -117.19568530281771
                        },
                        {
                            lat: 34.05920092649827,
                            lng: -117.19575894615099
                        },
                        {
                            lng: -117.19575574232981,
                            lat: 34.058861053180614
                        },
                        {
                            lng: -117.19575253850863,
                            lat: 34.05852117986296
                        },
                        {
                            lng: -117.19574933468745,
                            lat: 34.0581813065453
                        },
                        {
                            lng: -117.19574613086627,
                            lat: 34.057841433227644
                        },
                        {
                            lng: -117.19574292704509,
                            lat: 34.05750155990999
                        },
                        {
                            lng: -117.19573972322391,
                            lat: 34.05716168659233
                        },
                        {
                            lng: -117.19573651940273,
                            lat: 34.056821813274674
                        },
                        {
                            lng: -117.19573331558155,
                            lat: 34.05648193995702
                        },
                        {
                            lat: 34.05648193995701,
                            lng: -117.19573331558153
                        },
                        {
                            lng: -117.19569416670383,
                            lat: 34.056482788881965
                        },
                        {
                            lng: -117.19565501782613,
                            lat: 34.05648363780692
                        }
                    ],
                    currentCoordIndex = 0;

                geolocate.use();

                setInterval(function () {
                    geolocate.change(coords[currentCoordIndex]);
                    currentCoordIndex = (currentCoordIndex + 1) % coords.length;
                }, 1500);
            }

            function displayMap() {
                var portal = new Portal();

                // Once the portal has loaded, the user is signed in
                portal.load().then(function () {
                    dom.byId("viewDiv").style.display = "flex";

                    // TODO stubGeolocation();

                    var map = new Map({
                        basemap: "streets-navigation-vector"/*,
                        layers: trafficLayer*/
                    });

                    var view = new MapView({
                        container: "viewDiv",
                        map: map,
                        center: [-40, 28],
                        zoom: 2,
                        ui: {
                            components: ["attribution"]
                        }
                    });

                    var track = new Track({
                        view: view,
                        graphic: new Graphic({
                            symbol: {
                                type: "simple-marker",
                                size: "12px",
                                color: "green",
                                outline: {
                                    color: "#efefef",
                                    width: "1.5px"
                                }
                            }
                        }),
                        useHeadingEnabled: false,
                        goToOverride: function (view, options) {
                            options.target.scale = 50;  // Override the default map scale
                            return view.goTo(options.target);
                        }
                    });
                    view.ui.add(track, "top-left");


                    view.when(function () {
                        var prevLocation = view.center;

                        track.on("track", function () {
                            var location = track.graphic.geometry;

                            view
                                .goTo({
                                    center: location,
                                    tilt: 50,
                                    heading: 360 - getHeading(location, prevLocation), // only applies to SceneView
                                    rotation: 360 - getHeading(location, prevLocation) // only applies to MapView
                                })
                                .catch(function (error) {
                                    if (error.name != "AbortError") {
                                        console.error(error);
                                    }
                                });

                            prevLocation = location.clone();
                        });

                        track.start();
                    });

                    /*TODO view.when(disableZooming);*/

                    var traffic = new MapImageLayer({
                        url: "https://traffic.arcgis.com/arcgis/rest/services/World/Traffic/MapServer"
                    });

                    map.add(traffic);

                    // Pitesti
                    var latitude_p = 44.842849;
                    var longitude_p = 24.8798695;

                    // Bucuresti (wrong coordinates)
                    var latitude_b = 44.44676580000001;
                    var longitude_b = 26.0009209;
                    
                    drawCircle(view, latitude_b, longitude_b);
                });
            }

            function randomizeLatitude(latitude, offset) {
                //Earth’s radius, sphere
                var R = 6378137;

                //Coordinate offsets in radians
                var dLat = offset/R;

                //OffsetPosition, decimal degrees
                return latitude + dLat * 180 / Math.PI;
            }

            /**
             * Add offset to longitude
             *
             * !!IMPORTANT!! Because of this approx. transformation, sometimes are generated circles with some calculus
             * error
             *
             * @param longitude longitude to add offset
             * @param offset the offset
             * @param latitude latitude
             * @returns {*} the longitude with offset
             */
            function randomizeLongitude(longitude, offset, latitude) {
                //Earth’s radius, sphere
                var R = 6378137;

                //Coordinate offsets in radians
                var dLon = offset/(R*Math.cos(Math.PI*latitude/180));

                return longitude + dLon * 180/Math.PI;
            }

            /**
             * Function to get a random integer in the interval [min, max)
             * @param min integer
             * @param max integer
             * @returns {*} the random number
             */
            function getRndInteger(min, max) {
                return Math.floor(Math.random() * (max - min)) + min;
            }

            /**
             * Function used to draw 3 circles and the objective based o a point
             * @param view
             * @param latitude
             * @param longitude
             */
            function drawCircle(view, latitude, longitude){ //draws the circle
                view.graphics.removeAll();

                // calculate the offset random to be sure that the point is different from circle center
                var random_offset_1 = getRndInteger(-500, 500);
                var random_offset_2 = getRndInteger(-Math.abs(random_offset_1)/2, Math.abs(random_offset_1)/2);
                var random_offset_3 = getRndInteger(-Math.abs(random_offset_2)/2, Math.abs(random_offset_2)/2);

                // build the (lat, long) center for every circle
                var lat_1 = randomizeLatitude(latitude, random_offset_1);
                var long_1 = randomizeLongitude(longitude, random_offset_1, latitude);

                var lat_2 = randomizeLatitude(latitude, random_offset_2);
                var long_2 = randomizeLongitude(longitude, random_offset_2, latitude);

                var lat_3 = randomizeLatitude(latitude, random_offset_3);
                var long_3 = randomizeLongitude(longitude, random_offset_3, latitude);

                // create points for the circles
                var point_1 = {
                    type: "point",
                    latitude: lat_1,
                    longitude: long_1
                };

                var point_2 = {
                    type: "point",
                    latitude: lat_2,
                    longitude: long_2
                };

                var point_3 = {
                    type: "point",
                    latitude: lat_3,
                    longitude: long_3
                };

                // the objective himself
                var point_center = {
                    type: "point",
                    latitude: latitude,
                    longitude: longitude
                };

                // build the circles
                var circle_geometry_1 = new Circle({
                    center: point_1,
                    radiusUnit: "meters",
                    radius: 1000,
                    numberOfPoints: 1000,
                    geodesic: true
                });

                var circle_geometry_2 = new Circle({
                    center: point_2,
                    radiusUnit: "meters",
                    radius: 500,
                    numberOfPoints: 1000,
                    geodesic: true
                });

                var circle_geometry_3 = new Circle({
                    center: point_3,
                    radiusUnit: "meters",
                    radius: 250,
                    numberOfPoints: 1000,
                    geodesic: true
                });

                var circle_geometry_center = new Circle({
                    center: point_center,
                    radiusUnit: "meters",
                    radius: 10,
                    numberOfPoints: 1000,
                    geodesic: true
                });

                var circle_symbol_1 = {
                    type: "simple-fill",
                    color: [0, 255, 0, 0.8],
                    style: "solid",
                    outline:{
                        color: [255, 255, 255],
                        width: 1
                    }
                };

                var circle_symbol_2 = {
                    type: "simple-fill",
                    color: [255, 255, 0, 0.8],
                    style: "solid",
                    outline:{
                        color: [255, 255, 255],
                        width: 1
                    }
                };

                var circle_symbol_3 = {
                    type: "simple-fill",
                    color: [255, 0, 0, 0.8],
                    style: "solid",
                    outline:{
                        color: [255, 255, 255],
                        width: 1
                    }
                };

                var circle_symbol_center = {
                    type: "simple-fill",
                    color: [0, 0, 0, 1],
                    style: "solid",
                    outline:{
                        color: [0, 0, 0],
                        width: 1
                    }
                };

                // build circles graphics
                var circleGraphic = new Graphic({
                    geometry: circle_geometry_1,
                    symbol: circle_symbol_1
                });

                var circleGraphic_2 = new Graphic({
                    geometry: circle_geometry_2,
                    symbol: circle_symbol_2
                });

                var circleGraphic_3 = new Graphic({
                    geometry: circle_geometry_3,
                    symbol: circle_symbol_3
                });

                var circleGraphic_4 = new Graphic({
                    geometry: circle_geometry_center,
                    symbol: circle_symbol_center
                });

                view.graphics.add(circleGraphic);
                view.graphics.add(circleGraphic_2);
                view.graphics.add(circleGraphic_3);
                view.graphics.add(circleGraphic_4);
            }
        });

    </script>
</head>
<body>
<div id="anonymousPanel" style="display: block; padding: 5px; text-align: center;">
    <span id="sign-in" class="action">Sign In</span> to IMPOSTORII.
</div>

<div id="personalizedPanel" style="display: none; padding: 5px; text-align: center;">
    Welcome <span id="userId" style="font-weight: bold;"></span> &nbsp;-&nbsp;
    <span id="sign-out" class="action">Sign Out</span>
</div>
<!-- for the map -->
<div id="viewDiv" style="display: none;"></div>
</body>
</html>